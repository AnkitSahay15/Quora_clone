"use strict";var app=angular.module("quora",["ui.router","infinite-scroll","hc.marked","oitozero.ngSweetAlert"]);app.constant("tokenStorageKey","my-token"),app.filter("unsafe",function(o){return function(e){return o.trustAsHtml(e)}}).run(function(o,e){o.$on("logout",function(){o.$broadcast("loggedOut")}),o.$on("login",function(){o.$broadcast("loggedIn")}),o.$on("tag posts",function(e,t){o.$broadcast("filteredByTags",t)}),o.$on("getNotifications",function(e,t){o.$broadcast("notifications",t)}),o.isNotLoggedIn=function(){swal({title:"Not Logged In!",text:"You must be logged in to complete this action.",showCancelButton:!0,confirmButtonColor:"#B92B27",confirmButtonText:"Go to Login?",closeOnConfirm:!1,imageUrl:"../assets/Tied_Hands-100.png"},function(){swal({title:"Redirecting!",type:"success",timer:750,showConfirmButton:!1}),e.go("users.login")})}}),app.config(["$stateProvider","$locationProvider","$urlRouterProvider","markedProvider",function(o,e,t,n){e.html5Mode(!0).hashPrefix("!"),n.setOptions({gfm:!0,tables:!0,highlight:function(o,e){return e?hljs.highlight(e,o,!0).value:hljs.highlightAuto(o).value}}),o.state("home",{url:"/",templateUrl:"/html/general/home.html",controller:"homeCtrl"}).state("thread",{url:"/thread/:thread?",templateUrl:"/html/general/thread.html",controller:"threadCtrl"}).state("compose",{url:"/compose",templateUrl:"/html/general/compose.html",controller:"composeCtrl"}).state("topic",{url:"/topics/:topic?",templateUrl:"/html/general/topic.html",controller:"topicCtrl"}).state("users",{"abstract":!0,templateUrl:"/html/users/users.html"}).state("users.login",{url:"/login",templateUrl:"/html/users/form.html",controller:"usersCtrl"}).state("users.notifications",{url:"/notifications",templateUrl:"/html/users/notifications.html",controller:"notificationsCtrl"}).state("users.profile",{url:"/profile/:user?",templateUrl:"/html/users/profile.html",controller:"profileCtrl"}),t.otherwise("/")}]),app.controller("composeCtrl",function(o,e,t,n,s,i,r){var c=s.currentUser();$(document).foundation(),o.topics=[],o.selectedTopic,o.toggleDropdown=!1,function(){r.getTopics().success(function(e){o.topics=e,console.log(e)}).error(function(o){console.log("error: ",o)});var e={postType:"question"};i.getSortedPosts(e).success(function(e){o.topQuestion=e[0]}).error(function(o){console.log("error: ",o)})}(),o.addTopicToPost=function(e){o.selectedTopic=e.name,o.toggleDropdown=!0,window.setTimeout(function(){o.toggleDropdown=!1},50)},o.submitQuestion=function(o,e){var n={author:c._id,title:o.title,tags:o.tags,content:o.content,topic:e,postType:"question",token:s.getToken()};console.log(n),i.createPost(n).success(function(o){t.path("thread/"+o._id)}).error(function(o){console.log(o)})},o.submitTopic=function(e){console.log("SUBMIT POST FUNCTION STARTS");var t={name:e.name,about:e.about,token:s.getToken()};r.createTopic(t).success(function(e){o.topics.push(e),swal({title:"Success!",text:"You've made a new Topic!",timer:750,showConfirmButton:!1}),n.go("compose")}).error(function(o){swal({title:"Error!",text:"Missing fields!",showConfirmButton:!0})})},o.$emit("getNotifications")}),app.controller("homeCtrl",function(o,e,t,n,s,i,r,c,l){o.posts,o.topicFeed;var u=i.currentUser();o.loggedIn=i.isLoggedIn(),o.getPosts=function(e){o.posts=[],o.topicFeed=[];var i={postType:"question",sortingMethod:e};t.getSortedPosts(i).success(function(e){o.loggedIn?(t.formatLikedPosts(e,u),o.posts=e):o.posts=e}).error(function(o){console.log("error: ",o)}),s.get7Topics().success(function(e){o.topicFeed=e}).error(function(o){console.log("error: ",o)}),n.getUser(u._id).success(function(e){console.log("user: ",e),o.subscriptions=e.subscriptions}).error(function(o){console.log("error: ",o)})},o.getPosts("likes"),o.sortLikes=function(){$(".filter").removeClass("active"),$("#likes").addClass("active"),o.getPosts("likes")},o.sortDislikes=function(){$(".filter").removeClass("active"),$("#dislikes").addClass("active"),o.getPosts("dislikes")},o.sortOldest=function(){$(".filter").removeClass("active"),$("#oldest").addClass("active"),o.getPosts("oldest")},o.sortNewest=function(){$(".filter").removeClass("active"),$("#newest").addClass("active"),o.getPosts("newest")},o.togglePostLike=function(e){if(o.loggedIn){var n;n=o.posts[e].liked?"unlike":"like";var s={pid:o.posts[e]._id,uid:u._id,type:n,token:i.getToken()};t.changeStats(s).success(function(t){"like"===n?(o.posts[e].likes+=1,o.posts[e].liked=!0):(o.posts[e].likes-=1,o.posts[e].liked=!1)}).error(function(o){console.log("error: ",o)})}else l.isNotLoggedIn()},o.togglePostDislike=function(e){if(o.loggedIn){var n;n=o.posts[e].disliked?"undo":"dislike";var s={pid:o.posts[e]._id,uid:u._id,type:n,token:i.getToken()};t.changeStats(s).success(function(t){"dislike"===n?(o.posts[e].dislikes+=1,o.posts[e].disliked=!0):(o.posts[e].dislikes-=1,o.posts[e].disliked=!1)}).error(function(o){console.log("error: ",o)})}else l.isNotLoggedIn()},o.toggleCommentLike=function(e){if(o.loggedIn){var n;n=o.comments[e].liked?"unlike":"like";var s={pid:o.comments[e]._id,uid:u._id,type:n,token:i.getToken()};t.changeStats(s).success(function(t){"like"===n?(o.comments[e].likes+=1,o.comments[e].liked=!0):(o.comments[e].likes-=1,o.comments[e].liked=!1)}).error(function(o){console.log("error: ",o)})}else l.isNotLoggedIn()},o.toggleCommentDislike=function(e){if(o.loggedIn){var n;n=o.comments[e].disliked?"undo":"dislike";var s={pid:o.comments[e]._id,uid:u._id,type:n,token:i.getToken()};t.changeStats(s).success(function(t){"dislike"===n?(o.comments[e].dislikes+=1,o.comments[e].disliked=!0):(o.comments[e].dislikes-=1,o.comments[e].disliked=!1)}).error(function(o){console.log("error: ",o)})}else l.isNotLoggedIn()},o.showComments=function(e){o.posts[e].showComments=!0;var n=(o.posts[e].comments,{sortingMethod:"likes",pid:o.posts[e]._id});t.getSortedComments(n).success(function(e){u?(t.formatLikedPosts(e,u),o.comments=e):o.comments=e})},o.hideComments=function(e){o.posts[e].showComments=!1},o.submitComment=function(e,n){if(o.loggedIn){var s={content:e,author:u._id,responseTo:n._id,postType:"comment",token:i.getToken()};t.createPost(s).success(function(e){o.comments.push(e)}).error(function(o){console.log("error: ",o)})}else l.isNotLoggedIn()},o.$emit("getNotifications"),o.$on("filteredByTags",function(e,n){t.formatLikedPosts(n,u),o.posts=n}),o.$on("loggedOut",function(){o.loggedIn=i.isLoggedIn(),o.getPosts()}),o.$on("loggedIn",function(){o.loggedIn=i.isLoggedIn()}),t.getPostsByTag()}),app.controller("notificationsCtrl",function(o,e,t,n,s,i){o.currentUser=t.currentUser(),o.newNotifications,o.oldNotifications,(o.getNotifications=function(){o.newNotifications=[],o.oldNotifications=[];var e={uid:o.currentUser._id};n.getNotifs(e).success(function(t){o.newNotifications=t.notifications.filter(function(o){return!o.seen}),o.oldNotifications=t.notifications.filter(function(o){return o.seen}),n.clearNotifs(e).success(function(o){console.log("user: ",o)}).error(function(o){console.log("error: ",o)})}).error(function(o){console.log("error: ",o)})})()}),app.controller("profileCtrl",function(o,e,t){$(document).foundation(),o.$emit("getNotifications")}),app.controller("threadCtrl",function(o,e,t,n,s,i){o.displayAnswerForm=!1;var r=t.currentUser();o.loggedIn=t.isLoggedIn(),o.answers,o.comments,o.question,(o.getPost=function(){var e={pid:i.thread};n.getPost(e).success(function(e){o.question=e,o.topic=e.topic,o.comments=e.comments;var t={sortingMethod:"likes",pid:e._id};n.getSortedAnswers(t).success(function(e){n.formatLikedPosts(e,r),o.answers=e})}).error(function(o){console.log(o)})})(),o.submitAnswer=function(e,s){var i={content:e,author:r._id,responseTo:s._id,postType:"answer",token:t.getToken()};n.createPost(i).success(function(e){o.answers.push(e),console.log(e)}).error(function(o){console.log("error: ",o)})},o.toggleAnswerLike=function(e){if(o.loggedIn){var i;i=o.answers[e].liked?"unlike":"like";var c={pid:o.answers[e]._id,uid:r._id,type:i,token:t.getToken()};n.changeStats(c).success(function(t){"like"===i?(o.answers[e].likes+=1,o.answers[e].liked=!0):(o.answers[e].likes-=1,o.answers[e].liked=!1)}).error(function(o){console.log("error: ",o)})}else s.isNotLoggedIn()},o.toggleAnswerDislike=function(e){if(o.loggedIn){var i;i=o.answers[e].disliked?"undo":"dislike";var c={pid:o.answers[e]._id,uid:r._id,type:i,token:t.getToken()};n.changeStats(c).success(function(t){"dislike"===i?(o.answers[e].dislikes+=1,o.answers[e].disliked=!0):(o.answers[e].dislikes-=1,o.answers[e].disliked=!1)}).error(function(o){console.log("error: ",o)})}else s.isNotLoggedIn()},o.toggleCommentLike=function(e){if(o.loggedIn){var i;i=o.comments[e].liked?"unlike":"like";var c={pid:o.comments[e]._id,uid:r._id,type:i,token:t.getToken()};n.changeStats(c).success(function(t){"like"===i?(o.comments[e].likes+=1,o.comments[e].liked=!0):(o.comments[e].likes-=1,o.comments[e].liked=!1)}).error(function(o){console.log("error: ",o)})}else s.isNotLoggedIn()},o.toggleCommentDislike=function(e){if(o.loggedIn){var i;i=o.comments[e].disliked?"undo":"dislike";var c={pid:o.comments[e]._id,uid:r._id,type:i,token:t.getToken()};n.changeStats(c).success(function(t){"dislike"===i?(o.comments[e].dislikes+=1,o.comments[e].disliked=!0):(o.comments[e].dislikes-=1,o.comments[e].disliked=!1)}).error(function(o){console.log("error: ",o)})}else s.isNotLoggedIn()},o.showComments=function(){var e={sortingMethod:"likes",pid:o.posts[index]._id};n.getSortedComments(e).success(function(e){r?(n.formatLikedPosts(e,r),o.comments=e):o.comments=e})},o.submitComment=function(e,i){if(console.log(i),o.loggedIn){var c={content:e,author:r._id,responseTo:i._id,postType:"comment",token:t.getToken()};n.createPost(c).success(function(e){o.comments.push(e)}).error(function(o){console.log("error: ",o)})}else s.isNotLoggedIn()},o.loadMore=function(){for(var e=o.comments[o.comments.length-1],t=8,n=1;t>=n;n++)console.log("count is "+n),o.comments.push(e+"")},o.$emit("getNotifications")}),app.controller("topicCtrl",function(o,e,t,n,s,i,r,c){var l=s.currentUser();o.loggedIn=s.isLoggedIn(),o.posts,o.topic,o.subscribed=!1,function(){n.getTopic(t.topic).success(function(e){console.log("TOPIC: ",e),r.formatLikedPosts(e.posts,l),e.subscribers.forEach(function(e){e===l._id?o.subscribed=!0:o.subscribed=!1}),o.topic=e,o.posts=e.posts}).error(function(o){console.log("error: ",o)})}(),o.subscribe=function(){var e={uid:l._id,topic:t.topic};console.log(e),i.subscribe(e).success(function(e){o.subscribed=!0}).error(function(o){console.log("error: ",o)})},o.unsubscribe=function(){var e={uid:l._id,topic:t.topic};i.unsubscribe(e).success(function(e){o.subscribed=!1}).error(function(o){console.log("error: ",o)})},o.togglePostLike=function(e){if(o.loggedIn){var t;t=o.posts[e].liked?"unlike":"like";var n={pid:o.posts[e]._id,uid:l._id,type:t,token:s.getToken()};r.changeStats(n).success(function(n){"like"===t?(o.posts[e].likes+=1,o.posts[e].liked=!0):(o.posts[e].likes-=1,o.posts[e].liked=!1)}).error(function(o){console.log("error: ",o)})}else c.isNotLoggedIn()},o.togglePostDislike=function(e){if(o.loggedIn){var t;t=o.posts[e].disliked?"undo":"dislike";var n={pid:o.posts[e]._id,uid:l._id,type:t,token:s.getToken()};r.changeStats(n).success(function(n){"dislike"===t?(o.posts[e].dislikes+=1,o.posts[e].disliked=!0):(o.posts[e].dislikes-=1,o.posts[e].disliked=!1)}).error(function(o){console.log("error: ",o)})}else c.isNotLoggedIn()},o.toggleCommentLike=function(e){if(o.loggedIn){var t;t=o.comments[e].liked?"unlike":"like";var n={pid:o.comments[e]._id,uid:l._id,type:t,token:s.getToken()};r.changeStats(n).success(function(n){"like"===t?(o.comments[e].likes+=1,o.comments[e].liked=!0):(o.comments[e].likes-=1,o.comments[e].liked=!1)}).error(function(o){console.log("error: ",o)})}else c.isNotLoggedIn()},o.toggleCommentDislike=function(e){if(o.loggedIn){var t;t=o.comments[e].disliked?"undo":"dislike";var n={pid:o.comments[e]._id,uid:l._id,type:t,token:s.getToken()};r.changeStats(n).success(function(n){"dislike"===t?(o.comments[e].dislikes+=1,o.comments[e].disliked=!0):(o.comments[e].dislikes-=1,o.comments[e].disliked=!1)}).error(function(o){console.log("error: ",o)})}else c.isNotLoggedIn()},o.showComments=function(e){o.posts[e].showComments=!0;var t=(o.posts[e].comments,{sortingMethod:"likes",pid:o.posts[e]._id});r.getSortedComments(t).success(function(e){r.formatLikedPosts(e,l),console.log(e),o.comments=e})},o.hideComments=function(e){o.posts[e].showComments=!1},o.submitComment=function(e,t){if(o.loggedIn){var n={content:e,author:l._id,responseTo:t._id,postType:"comment",token:s.getToken()};r.createPost(n).success(function(e){o.comments.push(e),console.log(e)}).error(function(o){console.log("error: ",o)})}else c.isNotLoggedIn()},o.$emit("getNotifications"),o.$on("loggedOut",function(){o.loggedIn=s.isLoggedIn()}),o.$on("loggedIn",function(){o.loggedIn=s.isLoggedIn()})}),app.controller("usersCtrl",function(o,e,t,n,s,i){o.Login=!1,o.loggedIn=t.isLoggedIn(),o.currentUser=t.currentUser(),o.newNotifications=[],o.currentUserName,o.photo,(o.switchState=function(){o.Login=!o.Login,o.Login?o.currentState="Create Account":o.currentState="Go to Login",o.Login?o.formState="Login":o.formState="Register"})(),o.submit=function(n){var s=o.Login?t.login:t.register;s(n).success(function(t){o.$emit("login"),e.go("home")}).error(function(e){swal({title:"Input Not Valid",text:"Either the username or password was entered incorrectly",timer:2e3,type:"error",confirmButtonColor:"#B92B27"}),o.user={}})},o.upload=function(){var e=new FormData;e.append("file",o.files[0]),console.log(e),n.addPhoto(e).success(function(o){console.log("Data: ",o)})},o.logout=function(){t.logout(),o.$emit("logout"),e.go("home")},o.filterByTag=function(e){s.getPostsByTag(e).success(function(e){o.$emit("tag posts",e)}).error(function(o){console.log("error: ",o)})},o.$on("notifications",function(){n.getUser(o.currentUser._id).success(function(e){o.newNotifications=e.notifications.filter(function(o){return!o.seen})}).error(function(o){console.log("error: ",o)})}),o.$on("loggedOut",function(){o.loggedIn=t.isLoggedIn(),o.notifications=[]}),o.$on("loggedIn",function(){o.loggedIn=t.isLoggedIn(),o.currentUser=t.currentUser()})}),app.directive("fileInput",["$parse",function(o){return{restrict:"A",link:function(e,t,n){t.bind("change",function(){o(n.fileInput).assign(e,t[0].files),e.$apply()})}}}]),app.factory("auth",function(o,e,t){var n={};return n.saveToken=function(e){o.localStorage[t]=e},n.getToken=function(){return o.localStorage[t]},n.isLoggedIn=function(){var e=n.getToken();if(e){var t=JSON.parse(o.atob(e.split(".")[1]));return t.exp>Date.now()/1e3}return!1},n.currentUser=function(){if(n.isLoggedIn()){var e=n.getToken(),t=JSON.parse(o.atob(e.split(".")[1]));return t}},n.register=function(o){return e.post("/auth/register",o).success(function(o){n.saveToken(o.token)})},n.login=function(o){return e.post("/auth/login",o).success(function(o){n.saveToken(o.token)})},n.logout=function(){o.localStorage.removeItem(t)},n}),app.factory("postFactory",function(o,e){var t={};return t.createPost=function(o){return e.post("/posts/add",o)},t.deletePost=function(o){return e["delete"]("/posts/delete",o)},t.changeStats=function(o){return e.put("/posts/changeStats",o)},t.getPost=function(o){return e.get("/posts/"+o.pid)},t.editPost=function(o){return e.put("/posts/edit",o)},t.getPostsByTag=function(o){return e.get("/posts/sorted/user/topic/tag/"+o+"/postType/")},t.getPostsByTopic=function(o){return e.get("/posts/sorted/user/topic/"+o+"/tag/postType/")},t.getSortedPosts=function(o){return e.get("/posts/sorted/"+o.sortingMethod+"/user/topic/tag/postType/"+o.postType)},t.getSortedComments=function(o){return console.log(o),e.get("/posts/sortedComments/"+o.sortingMethod+"/post/"+o.pid)},t.getSortedAnswers=function(o){return console.log(o),e.get("/posts/sortedComments/"+o.sortingMethod+"/post/"+o.pid)},t.formatLikedPosts=function(o,e){o.map(function(o){return o.likers.forEach(function(t){if(t.toString()===e._id.toString()){var n=o;return n.liked=!0,n}return o})}),o.map(function(o){return o.dislikers.forEach(function(t){if(t.toString()===e._id.toString()){var n=o;return n.disliked=!0,n}return o})})},t}),app.factory("topicFactory",function(o,e){var t={};return t.getTopics=function(){return e.get("/topics/allTopics")},t.subscribedTopics=function(){return e.get("/topics/allTopics")},t.get7Topics=function(){return e.get("/topics/limit7")},t.getTopic=function(o){return e.get("/topics/topic/"+o)},t.createTopic=function(o){return e.post("/topics/add",o)},t.deleteTopic=function(o){return e["delete"]("/topics/delete",o)},t}),app.factory("userFactory",function(o,e){var t={};return t.getUser=function(o){return e.get("/users/"+o)},t.getNotifs=function(o){return e.get("/users/notifications/"+o.uid)},t.addPhoto=function(o){return e.post("/users/addPhoto",o,{transformRequest:angular.identity,headers:{"Content-Type":void 0}})},t.clearNotifs=function(o){return e.post("/users/clearNotifications",o)},t.addKnowledge=function(o){return e.post("/users/addKnowledge",o)},t.updateInfo=function(o){return e.put("/users/updateInfo",o)},t.follow=function(o){return e.post("/users/follow",o)},t.unfollow=function(o){return e.put("/users/unfollow",o)},t.subscribe=function(o){return e.post("/users/subscribe",o)},t.unsubscribe=function(o){return e.put("/users/unsubscribe",o)},t});