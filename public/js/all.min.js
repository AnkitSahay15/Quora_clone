"use strict";var app=angular.module("quora",["ui.router","infinite-scroll","hc.marked","ngFileUpload"]);app.constant("tokenStorageKey","my-token"),app.filter("unsafe",function(t){return function(e){return t.trustAsHtml(e)}}).run(function(t,e){t.$on("logout",function(){t.$broadcast("loggedOut")}),t.$on("login",function(){t.$broadcast("loggedIn")}),t.$on("tag posts",function(e,o){t.$broadcast("filteredByTags",o)}),t.$on("getNotifications",function(e,o){t.$broadcast("notifications",o)}),t.$on("notHome",function(){t.$broadcast("removeTagFilter")}),t.$on("inHome",function(){t.$broadcast("addTagFilter")}),t.isNotLoggedIn=function(){swal({title:"Not Logged In!",text:"You must be logged in to complete this action.",showCancelButton:!0,confirmButtonColor:"#B92B27",confirmButtonText:"Go to Login?",closeOnConfirm:!1,imageUrl:"../assets/Tied_Hands-100.png"},function(){swal({title:"Redirecting!",type:"success",timer:750,showConfirmButton:!1}),e.go("users.login")})}}),app.config(["$stateProvider","$locationProvider","$urlRouterProvider","markedProvider",function(t,e,o,s){e.html5Mode(!0).hashPrefix("!"),s.setOptions({gfm:!0,tables:!0,highlight:function(t,e){return e?hljs.highlight(e,t,!0).value:hljs.highlightAuto(t).value}}),t.state("home",{url:"/",templateUrl:"/html/general/home.html",controller:"homeCtrl"}).state("thread",{url:"/thread/:thread?",templateUrl:"/html/general/thread.html",controller:"threadCtrl"}).state("compose",{url:"/compose",templateUrl:"/html/general/compose.html",controller:"composeCtrl"}).state("topic",{url:"/topics/:topic?",templateUrl:"/html/general/topic.html",controller:"topicCtrl"}).state("users",{"abstract":!0,templateUrl:"/html/users/users.html"}).state("users.login",{url:"/login",templateUrl:"/html/users/form.html",controller:"usersCtrl"}).state("users.notifications",{url:"/notifications",templateUrl:"/html/users/notifications.html",controller:"notificationsCtrl"}).state("users.profile",{url:"/profile/:user?",templateUrl:"/html/users/profile.html",controller:"profileCtrl"}),o.otherwise("/")}]),app.controller("composeCtrl",function(t,e,o,s,n,i,r){var c=n.currentUser();$(document).foundation(),t.topics=[],t.selectedTopic,t.toggleDropdown=!1,function(){r.getTopics().success(function(e){t.topics=e}).error(function(t){console.log("error: ",t)});var e={postType:"question"};i.getSortedPosts(e).success(function(e){t.topQuestion=e[0]})}(),t.addTopicToPost=function(e){t.selectedTopic=e.name,t.toggleDropdown=!0,window.setTimeout(function(){t.toggleDropdown=!1},50)},t.submitQuestion=function(t,e,s){if(t){var r={author:c._id,title:e.title,tags:e.tags,content:e.content,topic:s,postType:"question",token:n.getToken()};i.createPost(r).success(function(t){o.path("thread/"+t._id)}).error(function(t){console.log(t)})}else swal({title:"Invalid Form",text:"Incorrect Inputs",timer:2e3,type:"error",confirmButtonColor:"#B92B27"})},t.submitTopic=function(e){console.log("SUBMIT POST FUNCTION STARTS");var o={name:e.name,about:e.about,token:n.getToken()};r.createTopic(o).success(function(e){t.topics.push(e),swal({title:"Success!",text:"You've made a new Topic!",timer:750,showConfirmButton:!1}),s.go("compose")}).error(function(t){swal({title:"Error!",text:"Missing fields!",showConfirmButton:!0})})},t.$emit("notHome"),t.$emit("getNotifications")}),app.controller("homeCtrl",function(t,e,o,s,n,i,r,c,u){t.posts,t.topicFeed;var l=i.currentUser();t.loggedIn=i.isLoggedIn(),$(document).foundation(),t.loggedIn||e.go("users.login"),t.getPosts=function(e){t.posts=[],t.topicFeed=[];var i={postType:"question",sortingMethod:e};o.getSortedPosts(i).success(function(e){t.posts=e}),n.get7Topics().success(function(e){t.topicFeed=e}),s.getUser(l._id).success(function(e){t.subscriptions=e.subscriptions})},t.getPosts("likes"),t.sortLikes=function(){$(".filter").removeClass("active"),$("#likes").addClass("active"),t.getPosts("likes")},t.sortDislikes=function(){$(".filter").removeClass("active"),$("#dislikes").addClass("active"),t.getPosts("dislikes")},t.sortOldest=function(){$(".filter").removeClass("active"),$("#oldest").addClass("active"),t.getPosts("oldest")},t.sortNewest=function(){$(".filter").removeClass("active"),$("#newest").addClass("active"),t.getPosts("newest")},t.sortSubscriptions=function(){$(".filter").removeClass("active"),$("#subscriptions").addClass("active"),o.subscriptionsPosts(l._id).success(function(e){t.posts=e})},t.togglePostLike=function(e,s){var n=void 0,r=void 0;n="post"===e?t.posts:t.comments,r=n[s].liked?"unlike":"like";var c={pid:n[s]._id,uid:l._id,type:r,token:i.getToken()};o.changeStats(c).success(function(t){"like"===r?(n[s].likes+=1,n[s].liked=!0):(n[s].likes-=1,n[s].liked=!1)})},t.togglePostDislike=function(e,s){var n=void 0,r=void 0;n="post"===e?t.posts:t.comments,r=n[s].disliked?"undo":"dislike";var c={pid:n[s]._id,uid:l._id,type:r,token:i.getToken()};o.changeStats(c).success(function(t){"dislike"===r?(n[s].dislikes+=1,n[s].disliked=!0):(n[s].dislikes-=1,n[s].disliked=!1)})},t.showComments=function(e){t.posts[e].showComments=!0;var s=(t.posts[e].comments,{sortingMethod:"likes",pid:t.posts[e]._id});o.getSortedComments(s).success(function(e){t.comments=e})},t.hideComments=function(e){t.posts[e].showComments=!1},t.submitComment=function(e,s){var n={content:e,author:l._id,responseTo:s._id,postType:"comment",token:i.getToken()};o.createPost(n).success(function(e){t.comments.push(e)}).error(function(t){console.log("failed to submit comment"),console.error(t)})},t.deletePost=function(e,s){o.deletePost(e._id).success(function(e){switch(e.postType){case"comment":t.comments.splice(s,1);break;case"question":t.posts.splice(s,1)}}).error(function(t){console.log("failed at deletePost function "),console.error(t)})},t.$emit("getNotifications"),t.$emit("inHome"),t.$on("filteredByTags",function(e,o){t.posts=o}),t.$on("loggedOut",function(){t.loggedIn=i.isLoggedIn(),t.getPosts()}),t.$on("loggedIn",function(){t.loggedIn=i.isLoggedIn()})}),app.controller("notificationsCtrl",function(t,e,o,s,n,i){t.currentUser=o.currentUser(),t.newNotifications,t.oldNotifications,$(document).foundation(),(t.getNotifications=function(){t.newNotifications=[],t.oldNotifications=[];var e={uid:t.currentUser._id};s.getNotifs(e).success(function(o){t.newNotifications=o.notifications.filter(function(t){return!t.seen}),t.oldNotifications=o.notifications.filter(function(t){return t.seen}),s.clearNotifs(e).success(function(t){console.log("user: ",t)}).error(function(t){console.log("error: ",t)})}).error(function(t){console.log("error: ",t)})})(),t.$emit("notHome")}),app.controller("profileCtrl",function(t,e,o,s,n,i,r){$(document).foundation(),t.currentUser=!1,t.followed=!1;var c=n.currentUser();i.getUser(o.user).success(function(e){e._id===n.currentUser()._id&&(t.currentUser=!0),-1!==e.followers.indexOf(c._id)?t.followed=!0:t.followed=!1,t.user=e}),t.togglePostLike=function(e,o){var s=void 0,i=void 0;s="post"===e?t.user.posts:t.comments,i=s[o].liked?"unlike":"like";var u={pid:s[o]._id,uid:c._id,type:i,token:n.getToken()};r.changeStats(u).success(function(t){"like"===i?(s[o].likes+=1,s[o].liked=!0):(s[o].likes-=1,s[o].liked=!1)})},t.togglePostDislike=function(e,o){var s=void 0,i=void 0;s="post"===e?t.user.posts:t.comments,i=s[o].disliked?"undo":"dislike";var u={pid:s[o]._id,uid:c._id,type:i,token:n.getToken()};r.changeStats(u).success(function(t){"dislike"===i?(s[o].dislikes+=1,s[o].disliked=!0):(s[o].dislikes-=1,s[o].disliked=!1)})},t.showComments=function(e){t.user.posts[e].showComments=!0;var o=(t.user.posts[e].comments,{sortingMethod:"likes",pid:t.user.posts[e]._id});r.getSortedComments(o).success(function(e){t.comments=e})},t.hideComments=function(e){t.user.posts[e].showComments=!1},t.submitComment=function(o,s){var i={content:o,author:c._id,responseTo:s._id,postType:"comment",token:n.getToken()};r.createPost(i).success(function(e){t.comments.push(e)}).error(function(t){e.warning("failed to submit comment"),e.error(t)})},t.deletePost=function(o,s){r.deletePost(o._id).success(function(e){switch(e.postType){case"comment":t.comments.splice(s,1);break;case"question":t.posts.splice(s,1)}}).error(function(t){e.warning("failed at deletePost function "),e.error(t)})},t.updateInfo=function(e){i.updateInfo(e).then(function(e){t.user=e.data})},t.$emit("getNotifications"),t.$emit("notHome")}),app.controller("threadCtrl",function(t,e,o,s,n,i){t.displayAnswerForm=!1;var r=o.currentUser();t.loggedIn=o.isLoggedIn(),$(document).foundation(),t.answers,t.comments,t.question,(t.getPost=function(){s.getPost(i.thread).success(function(e){t.question=e,t.topic=e.topic,t.comments=e.comments;var o={sortingMethod:"likes",pid:e._id};s.getSortedAnswers(o).success(function(e){t.answers=e})}).error(function(t){console.log(t)})})(),t.submitAnswer=function(e,n){var i={content:e,author:r._id,responseTo:n._id,postType:"answer",token:o.getToken()};s.createPost(i).success(function(e){t.answers.push(e)}).error(function(t){console.log("error: ",t)})},t.toggleAnswerLike=function(e){if(t.loggedIn){var i;i=t.answers[e].liked?"unlike":"like";var c={pid:t.answers[e]._id,uid:r._id,type:i,token:o.getToken()};s.changeStats(c).success(function(o){"like"===i?(t.answers[e].likes+=1,t.answers[e].liked=!0):(t.answers[e].likes-=1,t.answers[e].liked=!1)}).error(function(t){console.log("error: ",t)})}else n.isNotLoggedIn()},t.toggleAnswerDislike=function(e){if(t.loggedIn){var i;i=t.answers[e].disliked?"undo":"dislike";var c={pid:t.answers[e]._id,uid:r._id,type:i,token:o.getToken()};s.changeStats(c).success(function(o){"dislike"===i?(t.answers[e].dislikes+=1,t.answers[e].disliked=!0):(t.answers[e].dislikes-=1,t.answers[e].disliked=!1)}).error(function(t){console.log("error: ",t)})}else n.isNotLoggedIn()},t.toggleCommentLike=function(e){if(t.loggedIn){var i;i=t.comments[e].liked?"unlike":"like";var c={pid:t.comments[e]._id,uid:r._id,type:i,token:o.getToken()};s.changeStats(c).success(function(o){"like"===i?(t.comments[e].likes+=1,t.comments[e].liked=!0):(t.comments[e].likes-=1,t.comments[e].liked=!1)}).error(function(t){console.log("error: ",t)})}else n.isNotLoggedIn()},t.toggleCommentDislike=function(e){if(t.loggedIn){var i;i=t.comments[e].disliked?"undo":"dislike";var c={pid:t.comments[e]._id,uid:r._id,type:i,token:o.getToken()};s.changeStats(c).success(function(o){"dislike"===i?(t.comments[e].dislikes+=1,t.comments[e].disliked=!0):(t.comments[e].dislikes-=1,t.comments[e].disliked=!1)}).error(function(t){console.log("error: ",t)})}else n.isNotLoggedIn()},t.showComments=function(){var e={sortingMethod:"likes",pid:t.posts[index]._id};s.getSortedComments(e).success(function(e){r?(s.formatPosts(e,r),t.comments=e):t.comments=e})},t.submitComment=function(e,i){if(console.log(i),t.loggedIn){var c={content:e,author:r._id,responseTo:i._id,postType:"comment",token:o.getToken()};s.createPost(c).success(function(e){t.comments.push(e)}).error(function(t){console.log("error: ",t)})}else n.isNotLoggedIn()},t.loadMore=function(){for(var e=t.comments[t.comments.length-1],o=8,s=1;o>=s;s++)console.log("count is "+s),t.comments.push(e+"")},t.$emit("notHome"),t.$emit("getNotifications")}),app.controller("topicCtrl",function(t,e,o,s,n,i,r,c){var u=n.currentUser();t.loggedIn=n.isLoggedIn(),t.posts,t.topic,t.subscribed=!1,$(document).foundation(),function(){s.getTopic(o.topic).success(function(e){console.log("TOPIC: ",e),e.subscribers.forEach(function(e){e===u._id?t.subscribed=!0:t.subscribed=!1}),t.topic=e,r.formatPosts(e.posts,u),t.posts=e.posts}).error(function(t){console.log("error: ",t)})}(),t.subscribe=function(){var e={uid:u._id,topic:o.topic};console.log(e),i.subscribe(e).success(function(e){t.subscribed=!0}).error(function(t){console.log("error: ",t)})},t.unsubscribe=function(){var e={uid:u._id,topic:o.topic};i.unsubscribe(e).success(function(e){t.subscribed=!1}).error(function(t){console.log("error: ",t)})},t.togglePostLike=function(e){if(t.loggedIn){var o;o=t.posts[e].liked?"unlike":"like";var s={pid:t.posts[e]._id,uid:u._id,type:o,token:n.getToken()};r.changeStats(s).success(function(s){"like"===o?(t.posts[e].likes+=1,t.posts[e].liked=!0):(t.posts[e].likes-=1,t.posts[e].liked=!1)}).error(function(t){console.log("error: ",t)})}else c.isNotLoggedIn()},t.togglePostDislike=function(e){if(t.loggedIn){var o;o=t.posts[e].disliked?"undo":"dislike";var s={pid:t.posts[e]._id,uid:u._id,type:o,token:n.getToken()};r.changeStats(s).success(function(s){"dislike"===o?(t.posts[e].dislikes+=1,t.posts[e].disliked=!0):(t.posts[e].dislikes-=1,t.posts[e].disliked=!1)}).error(function(t){console.log("error: ",t)})}else c.isNotLoggedIn()},t.toggleCommentLike=function(e){if(t.loggedIn){var o;o=t.comments[e].liked?"unlike":"like";var s={pid:t.comments[e]._id,uid:u._id,type:o,token:n.getToken()};r.changeStats(s).success(function(s){"like"===o?(t.comments[e].likes+=1,t.comments[e].liked=!0):(t.comments[e].likes-=1,t.comments[e].liked=!1)}).error(function(t){console.log("error: ",t)})}else c.isNotLoggedIn()},t.toggleCommentDislike=function(e){if(t.loggedIn){var o;o=t.comments[e].disliked?"undo":"dislike";var s={pid:t.comments[e]._id,uid:u._id,type:o,token:n.getToken()};r.changeStats(s).success(function(s){"dislike"===o?(t.comments[e].dislikes+=1,t.comments[e].disliked=!0):(t.comments[e].dislikes-=1,t.comments[e].disliked=!1)}).error(function(t){console.log("error: ",t)})}else c.isNotLoggedIn()},t.showComments=function(e){t.posts[e].showComments=!0;var o=(t.posts[e].comments,{sortingMethod:"likes",pid:t.posts[e]._id});r.getSortedComments(o).success(function(e){r.formatPosts(e,u),console.log(e),t.comments=e})},t.hideComments=function(e){t.posts[e].showComments=!1},t.submitComment=function(e,o){if(t.loggedIn){var s={content:e,author:u._id,responseTo:o._id,postType:"comment",token:n.getToken()};r.createPost(s).success(function(e){t.comments.push(e),console.log(e)}).error(function(t){console.log("error: ",t)})}else c.isNotLoggedIn()},t.$emit("notHome"),t.$emit("getNotifications"),t.$on("loggedOut",function(){t.loggedIn=n.isLoggedIn()}),t.$on("loggedIn",function(){t.loggedIn=n.isLoggedIn()})}),app.controller("usersCtrl",function(t,e,o,s,n,i,r,c){t.Login=!1,t.tagFilter=!0,t.loggedIn=o.isLoggedIn(),t.currentUser=o.currentUser(),t.newNotifications=[],(t.switchState=function(){t.Login=!t.Login,t.Login?t.currentState="Create Account":t.currentState="Go to Login",t.Login?t.formState="Login":t.formState="Register"})(),t.login=function(s,n){var i={username:s,password:n};o.login(i).success(function(o){t.$emit("login"),e.go("home")}).error(function(t){swal({title:"Input Not Valid??",text:"Either the username or password was entered incorrectly",timer:2e3,type:"error",confirmButtonColor:"#B92B27"})})},t.register=function(s){s.upload=r.upload({url:"auth/register",data:{file:s,username:t.username,email:t.email,fullName:t.fullName,password:t.password}}),s.upload.then(function(n){o.saveToken(n.data.token),t.$emit("login"),c(function(){s.result=n.data,e.go("home")})},function(e){e.status>0&&(t.errorMsg=e.status+": "+e.data)},function(t){s.progress=Math.min(100,parseInt(100*t.loaded/t.total))})},t.logout=function(){o.logout(),t.$emit("logout"),e.go("users.login")},t.filterByTag=function(e){n.getPostsByTag(e).success(function(e){t.$emit("tag posts",e)}).error(function(t){console.log("error: ",t)})},t.$on("removeTagFilter",function(){t.tagFilter=!1}),t.$on("addTagFilter",function(){t.tagFilter=!0}),t.$on("notifications",function(){s.getUser(t.currentUser._id).success(function(e){t.picture=o.loggedInUser.picture,t.newNotifications=e.notifications.filter(function(t){return!t.seen})}).error(function(t){console.log("error: ",t)})}),t.$on("loggedOut",function(){t.loggedIn=o.isLoggedIn(),t.notifications=[]}),t.$on("loggedIn",function(){t.loggedIn=o.isLoggedIn(),t.currentUser=o.currentUser(),s.getUser(t.currentUser._id).success(function(e){t.picture=o.loggedInUser.picture,t.newNotifications=e.notifications.filter(function(t){return!t.seen})}).error(function(t){console.log("error: ",t)})})}),app.directive("ngEnter",function(){return function(t,e,o){e.bind("keydown keypress",function(e){13===e.which&&(t.$apply(function(){t.$eval(o.ngEnter)}),e.preventDefault())})}}),app.factory("auth",function(t,e,o){var s={};return s.loggedInUser,s.saveToken=function(e){t.localStorage[o]=e},s.getToken=function(){return t.localStorage[o]},s.isLoggedIn=function(){var e=s.getToken();if(e){var o=JSON.parse(t.atob(e.split(".")[1]));return o.exp>Date.now()/1e3}return!1},s.currentUser=function(){if(s.isLoggedIn()){var o=s.getToken(),n=JSON.parse(t.atob(o.split(".")[1]));return e.get("/users/"+n._id).then(function(t){s.loggedInUser=t.data})["catch"](function(t){console.log("err",t)}),n}},s.register=function(t){return e.post("/auth/register",t).success(function(t){s.saveToken(t.token)})},s.login=function(t){return e.post("/auth/login",t).success(function(t){s.saveToken(t.token)})},s.logout=function(){t.localStorage.removeItem(o)},s}),app.factory("postFactory",function(t,e,o){var s={};return s.createPost=function(t){return e.post("/posts/add",t)},s.deletePost=function(t){return e["delete"]("/posts/delete/"+t)},s.changeStats=function(t){return e.put("/posts/changeStats",t)},s.getPost=function(t){return e.get("/posts/"+t)},s.editPost=function(t){return e.put("/posts/edit",t)},s.getPostsByTag=function(t){return e.get("/posts/sorted/user/topic/tag/"+t+"/postType/").success(function(t){return s.formatPosts(t,o.currentUser()),t})},s.getPostsByTopic=function(t){return e.get("/posts/sorted/user/topic/"+t+"/tag/postType/").success(function(t){return s.formatPosts(t,o.currentUser()),t})},s.getSortedPosts=function(t){return e.get("/posts/sorted/"+t.sortingMethod+"/user/topic/tag/postType/"+t.postType).success(function(t){return s.formatPosts(t,o.currentUser()),t})},s.subscriptionsPosts=function(t){return e.get("/posts/sorted/user/"+t+"/topic/tag/postType/").success(function(t){return s.formatPosts(t,o.currentUser()),t})},s.getSortedComments=function(t){return e.get("/posts/sortedComments/"+t.sortingMethod+"/post/"+t.pid).success(function(t){return s.formatPosts(t,o.currentUser()),t})},s.getSortedAnswers=function(t){return e.get("/posts/sortedComments/"+t.sortingMethod+"/post/"+t.pid).success(function(t){return s.formatPosts(t,o.currentUser()),t})},s.formatLikedPosts=function(t,e){t.map(function(t){return t.likers.forEach(function(o){if(o.toString()===e._id.toString()){var s=t;return s.liked=!0,s}return t})}),t.map(function(t){return t.dislikers.forEach(function(o){if(o.toString()===e._id.toString()){var s=t;return s.disliked=!0,s}return t})})},s.formatTags=function(t){t.map(function(e){console.log(t);var o="";return e.tags.forEach(function(t){o+=t+", "}),e.tags=o,e})},s.formatUserPosts=function(t,e){t.map(function(t){t.author._id.toString()===e._id.toString()?t.userPost=!0:t.userPost=!1})},s.formatPosts=function(t,e){return s.formatLikedPosts(t,e),s.formatUserPosts(t,e),s.formatTags(t),t},s}),app.factory("topicFactory",function(t,e){var o={};return o.getTopics=function(){return e.get("/topics/allTopics")},o.subscribedTopics=function(){return e.get("/topics/allTopics")},o.get7Topics=function(){return e.get("/topics/limit7")},o.getTopic=function(t){return e.get("/topics/topic/"+t)},o.createTopic=function(t){return e.post("/topics/add",t)},o.deleteTopic=function(t){return e["delete"]("/topics/delete",t)},o}),app.factory("userFactory",function(t,e,o,s){var n={};return n.getUser=function(t){return e.get("/users/"+t).success(function(t){return o.formatPosts(t.posts,s.currentUser()),t})},n.getNotifs=function(t){return e.get("/users/notifications/"+t.uid)},n.clearNotifs=function(t){return e.post("/users/clearNotifications",t)},n.addKnowledge=function(t){return e.post("/users/addKnowledge",t)},n.updateInfo=function(t){var o=new Object;for(var n in t)0!==t[n].length&&(o[n]=t[n]);return o.uid=s.currentUser()._id,e.put("/users/updateInfo",o)},n.follow=function(t){return e.post("/users/follow",t)},n.unfollow=function(t){return e.put("/users/unfollow",t)},n.subscribe=function(t){return e.post("/users/subscribe",t)},n.unsubscribe=function(t){return e.put("/users/unsubscribe",t)},n});