"use strict";var app=angular.module("quora",["ui.router","infinite-scroll","hc.marked","oitozero.ngSweetAlert","ngFileUpload"]);app.constant("tokenStorageKey","my-token"),app.filter("unsafe",function(o){return function(t){return o.trustAsHtml(t)}}).run(function(o,t){o.$on("logout",function(){o.$broadcast("loggedOut")}),o.$on("login",function(){o.$broadcast("loggedIn")}),o.$on("tag posts",function(t,e){o.$broadcast("filteredByTags",e)}),o.$on("getNotifications",function(t,e){o.$broadcast("notifications",e)}),o.$on("notHome",function(){o.$broadcast("removeTagFilter")}),o.$on("inHome",function(){o.$broadcast("addTagFilter")}),o.isNotLoggedIn=function(){swal({title:"Not Logged In!",text:"You must be logged in to complete this action.",showCancelButton:!0,confirmButtonColor:"#B92B27",confirmButtonText:"Go to Login?",closeOnConfirm:!1,imageUrl:"../assets/Tied_Hands-100.png"},function(){swal({title:"Redirecting!",type:"success",timer:750,showConfirmButton:!1}),t.go("users.login")})}}),app.config(["$stateProvider","$locationProvider","$urlRouterProvider","markedProvider",function(o,t,e,n){t.html5Mode(!0).hashPrefix("!"),n.setOptions({gfm:!0,tables:!0,highlight:function(o,t){return t?hljs.highlight(t,o,!0).value:hljs.highlightAuto(o).value}}),o.state("home",{url:"/",templateUrl:"/html/general/home.html",controller:"homeCtrl"}).state("thread",{url:"/thread/:thread?",templateUrl:"/html/general/thread.html",controller:"threadCtrl"}).state("compose",{url:"/compose",templateUrl:"/html/general/compose.html",controller:"composeCtrl"}).state("topic",{url:"/topics/:topic?",templateUrl:"/html/general/topic.html",controller:"topicCtrl"}).state("users",{"abstract":!0,templateUrl:"/html/users/users.html"}).state("users.login",{url:"/login",templateUrl:"/html/users/form.html",controller:"usersCtrl"}).state("users.notifications",{url:"/notifications",templateUrl:"/html/users/notifications.html",controller:"notificationsCtrl"}).state("users.profile",{url:"/profile/:user?",templateUrl:"/html/users/profile.html",controller:"profileCtrl"}),e.otherwise("/")}]),app.controller("composeCtrl",function(o,t,e,n,s,i,r){var c=s.currentUser();$(document).foundation(),o.topics=[],o.selectedTopic,o.toggleDropdown=!1,function(){r.getTopics().success(function(t){o.topics=t,console.log(t)}).error(function(o){console.log("error: ",o)});var t={postType:"question"};i.getSortedPosts(t).success(function(t){o.topQuestion=t[0]}).error(function(o){console.log("error: ",o)})}(),o.addTopicToPost=function(t){o.selectedTopic=t.name,o.toggleDropdown=!0,window.setTimeout(function(){o.toggleDropdown=!1},50)},o.submitQuestion=function(o,t){var n={author:c._id,title:o.title,tags:o.tags,content:o.content,topic:t,postType:"question",token:s.getToken()};console.log(n),i.createPost(n).success(function(o){e.path("thread/"+o._id)}).error(function(o){console.log(o)})},o.submitTopic=function(t){console.log("SUBMIT POST FUNCTION STARTS");var e={name:t.name,about:t.about,token:s.getToken()};r.createTopic(e).success(function(t){o.topics.push(t),swal({title:"Success!",text:"You've made a new Topic!",timer:750,showConfirmButton:!1}),n.go("compose")}).error(function(o){swal({title:"Error!",text:"Missing fields!",showConfirmButton:!0})})},o.$emit("notHome"),o.$emit("getNotifications")}),app.controller("homeCtrl",function(o,t,e,n,s,i,r,c,l){o.posts,o.topicFeed;var u=i.currentUser();o.loggedIn=i.isLoggedIn(),o.loggedIn||t.go("users.login"),o.getPosts=function(t){o.posts=[],o.topicFeed=[];var i={postType:"question",sortingMethod:t};e.getSortedPosts(i).success(function(t){o.loggedIn?(e.formatPosts(t,u),console.log("posts",t),o.posts=t):o.posts=t}).error(function(o){console.log("error: ",o)}),s.get7Topics().success(function(t){o.topicFeed=t}).error(function(o){console.log("error: ",o)}),n.getUser(u._id).success(function(t){console.log("user: ",t),o.subscriptions=t.subscriptions}).error(function(o){console.log("error: ",o)})},o.getPosts("likes"),o.sortLikes=function(){$(".filter").removeClass("active"),$("#likes").addClass("active"),o.getPosts("likes")},o.sortDislikes=function(){$(".filter").removeClass("active"),$("#dislikes").addClass("active"),o.getPosts("dislikes")},o.sortOldest=function(){$(".filter").removeClass("active"),$("#oldest").addClass("active"),o.getPosts("oldest")},o.sortNewest=function(){$(".filter").removeClass("active"),$("#newest").addClass("active"),o.getPosts("newest")},o.sortSubscriptions=function(){$(".filter").removeClass("active"),$("#subscriptions").addClass("active"),e.subscriptionsPosts(u._id).success(function(t){e.formatPosts(t,u),o.posts=t}).error(function(o){console.log("error: ",o)})},o.togglePostLike=function(t){if(o.loggedIn){var n;n=o.posts[t].liked?"unlike":"like";var s={pid:o.posts[t]._id,uid:u._id,type:n,token:i.getToken()};e.changeStats(s).success(function(e){"like"===n?(o.posts[t].likes+=1,o.posts[t].liked=!0):(o.posts[t].likes-=1,o.posts[t].liked=!1)}).error(function(o){console.log("error: ",o)})}else l.isNotLoggedIn()},o.togglePostDislike=function(t){if(o.loggedIn){var n;n=o.posts[t].disliked?"undo":"dislike";var s={pid:o.posts[t]._id,uid:u._id,type:n,token:i.getToken()};e.changeStats(s).success(function(e){"dislike"===n?(o.posts[t].dislikes+=1,o.posts[t].disliked=!0):(o.posts[t].dislikes-=1,o.posts[t].disliked=!1)}).error(function(o){console.log("error: ",o)})}else l.isNotLoggedIn()},o.toggleCommentLike=function(t){if(o.loggedIn){var n;n=o.comments[t].liked?"unlike":"like";var s={pid:o.comments[t]._id,uid:u._id,type:n,token:i.getToken()};e.changeStats(s).success(function(e){"like"===n?(o.comments[t].likes+=1,o.comments[t].liked=!0):(o.comments[t].likes-=1,o.comments[t].liked=!1)}).error(function(o){console.log("error: ",o)})}else l.isNotLoggedIn()},o.toggleCommentDislike=function(t){if(o.loggedIn){var n;n=o.comments[t].disliked?"undo":"dislike";var s={pid:o.comments[t]._id,uid:u._id,type:n,token:i.getToken()};e.changeStats(s).success(function(e){"dislike"===n?(o.comments[t].dislikes+=1,o.comments[t].disliked=!0):(o.comments[t].dislikes-=1,o.comments[t].disliked=!1)}).error(function(o){console.log("error: ",o)})}else l.isNotLoggedIn()},o.showComments=function(t){o.posts[t].showComments=!0;var n=(o.posts[t].comments,{sortingMethod:"likes",pid:o.posts[t]._id});e.getSortedComments(n).success(function(t){u?(e.formatPosts(t,u),o.comments=t):o.comments=t})},o.hideComments=function(t){o.posts[t].showComments=!1},o.submitComment=function(t,n){if(o.loggedIn){var s={content:t,author:u._id,responseTo:n._id,postType:"comment",token:i.getToken()};e.createPost(s).success(function(t){o.comments.push(t)}).error(function(o){console.log("error: ",o)})}else l.isNotLoggedIn()},o.$emit("getNotifications"),o.$emit("inHome"),o.$on("filteredByTags",function(t,n){e.formatLikedPosts(n,u),e.formatTags(n),o.posts=n}),o.$on("loggedOut",function(){o.loggedIn=i.isLoggedIn(),o.getPosts()}),o.$on("loggedIn",function(){o.loggedIn=i.isLoggedIn()}),e.getPostsByTag()}),app.controller("notificationsCtrl",function(o,t,e,n,s,i){o.currentUser=e.currentUser(),o.newNotifications,o.oldNotifications,(o.getNotifications=function(){o.newNotifications=[],o.oldNotifications=[];var t={uid:o.currentUser._id};n.getNotifs(t).success(function(e){o.newNotifications=e.notifications.filter(function(o){return!o.seen}),o.oldNotifications=e.notifications.filter(function(o){return o.seen}),n.clearNotifs(t).success(function(o){console.log("user: ",o)}).error(function(o){console.log("error: ",o)})}).error(function(o){console.log("error: ",o)})})(),o.$emit("notHome")}),app.controller("profileCtrl",function(o,t,e){$(document).foundation(),o.$emit("getNotifications"),o.$emit("notHome")}),app.controller("threadCtrl",function(o,t,e,n,s,i){o.displayAnswerForm=!1;var r=e.currentUser();o.loggedIn=e.isLoggedIn(),o.answers,o.comments,o.question,(o.getPost=function(){var t={pid:i.thread};n.getPost(t).success(function(t){o.question=t,o.topic=t.topic,o.comments=t.comments;var e={sortingMethod:"likes",pid:t._id};n.getSortedAnswers(e).success(function(t){n.formatPosts(posts,r),o.answers=t})}).error(function(o){console.log(o)})})(),o.submitAnswer=function(t,s){var i={content:t,author:r._id,responseTo:s._id,postType:"answer",token:e.getToken()};n.createPost(i).success(function(t){o.answers.push(t),console.log(t)}).error(function(o){console.log("error: ",o)})},o.toggleAnswerLike=function(t){if(o.loggedIn){var i;i=o.answers[t].liked?"unlike":"like";var c={pid:o.answers[t]._id,uid:r._id,type:i,token:e.getToken()};n.changeStats(c).success(function(e){"like"===i?(o.answers[t].likes+=1,o.answers[t].liked=!0):(o.answers[t].likes-=1,o.answers[t].liked=!1)}).error(function(o){console.log("error: ",o)})}else s.isNotLoggedIn()},o.toggleAnswerDislike=function(t){if(o.loggedIn){var i;i=o.answers[t].disliked?"undo":"dislike";var c={pid:o.answers[t]._id,uid:r._id,type:i,token:e.getToken()};n.changeStats(c).success(function(e){"dislike"===i?(o.answers[t].dislikes+=1,o.answers[t].disliked=!0):(o.answers[t].dislikes-=1,o.answers[t].disliked=!1)}).error(function(o){console.log("error: ",o)})}else s.isNotLoggedIn()},o.toggleCommentLike=function(t){if(o.loggedIn){var i;i=o.comments[t].liked?"unlike":"like";var c={pid:o.comments[t]._id,uid:r._id,type:i,token:e.getToken()};n.changeStats(c).success(function(e){"like"===i?(o.comments[t].likes+=1,o.comments[t].liked=!0):(o.comments[t].likes-=1,o.comments[t].liked=!1)}).error(function(o){console.log("error: ",o)})}else s.isNotLoggedIn()},o.toggleCommentDislike=function(t){if(o.loggedIn){var i;i=o.comments[t].disliked?"undo":"dislike";var c={pid:o.comments[t]._id,uid:r._id,type:i,token:e.getToken()};n.changeStats(c).success(function(e){"dislike"===i?(o.comments[t].dislikes+=1,o.comments[t].disliked=!0):(o.comments[t].dislikes-=1,o.comments[t].disliked=!1)}).error(function(o){console.log("error: ",o)})}else s.isNotLoggedIn()},o.showComments=function(){var t={sortingMethod:"likes",pid:o.posts[index]._id};n.getSortedComments(t).success(function(t){r?(n.formatPosts(t,r),o.comments=t):o.comments=t})},o.submitComment=function(t,i){if(console.log(i),o.loggedIn){var c={content:t,author:r._id,responseTo:i._id,postType:"comment",token:e.getToken()};n.createPost(c).success(function(t){o.comments.push(t)}).error(function(o){console.log("error: ",o)})}else s.isNotLoggedIn()},o.loadMore=function(){for(var t=o.comments[o.comments.length-1],e=8,n=1;e>=n;n++)console.log("count is "+n),o.comments.push(t+"")},o.$emit("notHome"),o.$emit("getNotifications")}),app.controller("topicCtrl",function(o,t,e,n,s,i,r,c){var l=s.currentUser();o.loggedIn=s.isLoggedIn(),o.posts,o.topic,o.subscribed=!1,function(){n.getTopic(e.topic).success(function(t){console.log("TOPIC: ",t),r.formatPosts(posts,l),t.subscribers.forEach(function(t){t===l._id?o.subscribed=!0:o.subscribed=!1}),o.topic=t,o.posts=t.posts}).error(function(o){console.log("error: ",o)})}(),o.subscribe=function(){var t={uid:l._id,topic:e.topic};console.log(t),i.subscribe(t).success(function(t){o.subscribed=!0}).error(function(o){console.log("error: ",o)})},o.unsubscribe=function(){var t={uid:l._id,topic:e.topic};i.unsubscribe(t).success(function(t){o.subscribed=!1}).error(function(o){console.log("error: ",o)})},o.togglePostLike=function(t){if(o.loggedIn){var e;e=o.posts[t].liked?"unlike":"like";var n={pid:o.posts[t]._id,uid:l._id,type:e,token:s.getToken()};r.changeStats(n).success(function(n){"like"===e?(o.posts[t].likes+=1,o.posts[t].liked=!0):(o.posts[t].likes-=1,o.posts[t].liked=!1)}).error(function(o){console.log("error: ",o)})}else c.isNotLoggedIn()},o.togglePostDislike=function(t){if(o.loggedIn){var e;e=o.posts[t].disliked?"undo":"dislike";var n={pid:o.posts[t]._id,uid:l._id,type:e,token:s.getToken()};r.changeStats(n).success(function(n){"dislike"===e?(o.posts[t].dislikes+=1,o.posts[t].disliked=!0):(o.posts[t].dislikes-=1,o.posts[t].disliked=!1)}).error(function(o){console.log("error: ",o)})}else c.isNotLoggedIn()},o.toggleCommentLike=function(t){if(o.loggedIn){var e;e=o.comments[t].liked?"unlike":"like";var n={pid:o.comments[t]._id,uid:l._id,type:e,token:s.getToken()};r.changeStats(n).success(function(n){"like"===e?(o.comments[t].likes+=1,o.comments[t].liked=!0):(o.comments[t].likes-=1,o.comments[t].liked=!1)}).error(function(o){console.log("error: ",o)})}else c.isNotLoggedIn()},o.toggleCommentDislike=function(t){if(o.loggedIn){var e;e=o.comments[t].disliked?"undo":"dislike";var n={pid:o.comments[t]._id,uid:l._id,type:e,token:s.getToken()};r.changeStats(n).success(function(n){"dislike"===e?(o.comments[t].dislikes+=1,o.comments[t].disliked=!0):(o.comments[t].dislikes-=1,o.comments[t].disliked=!1)}).error(function(o){console.log("error: ",o)})}else c.isNotLoggedIn()},o.showComments=function(t){o.posts[t].showComments=!0;var e=(o.posts[t].comments,{sortingMethod:"likes",pid:o.posts[t]._id});r.getSortedComments(e).success(function(t){r.formatPosts(t,l),console.log(t),o.comments=t})},o.hideComments=function(t){o.posts[t].showComments=!1},o.submitComment=function(t,e){if(o.loggedIn){var n={content:t,author:l._id,responseTo:e._id,postType:"comment",token:s.getToken()};r.createPost(n).success(function(t){o.comments.push(t),console.log(t)}).error(function(o){console.log("error: ",o)})}else c.isNotLoggedIn()},o.$emit("notHome"),o.$emit("getNotifications"),o.$on("loggedOut",function(){o.loggedIn=s.isLoggedIn()}),o.$on("loggedIn",function(){o.loggedIn=s.isLoggedIn()})}),app.controller("usersCtrl",function(o,t,e,n,s,i,r,c){o.Login=!1,o.tagFilter=!0,o.loggedIn=e.isLoggedIn(),o.currentUser=e.currentUser(),o.newNotifications=[],(o.switchState=function(){o.Login=!o.Login,o.Login?o.currentState="Create Account":o.currentState="Go to Login",o.Login?o.formState="Login":o.formState="Register"})(),o.login=function(n,s){var i={username:n,password:s};e.login(i).success(function(e){o.$emit("login"),t.go("home")}).error(function(o){swal({title:"Input Not Valid",text:"Either the username or password was entered incorrectly",timer:2e3,type:"error",confirmButtonColor:"#B92B27"})})},o.register=function(n){n.upload=r.upload({url:"auth/register",data:{file:n,username:o.username,email:o.email,fullName:o.fullName,password:o.password}}),n.upload.then(function(s){e.saveToken(s.data.token),o.$emit("login"),c(function(){n.result=s.data,t.go("home")})},function(t){t.status>0&&(o.errorMsg=t.status+": "+t.data)},function(o){n.progress=Math.min(100,parseInt(100*o.loaded/o.total))})},o.logout=function(){e.logout(),o.$emit("logout"),t.go("home")},o.filterByTag=function(t){s.getPostsByTag(t).success(function(t){o.$emit("tag posts",t)}).error(function(o){console.log("error: ",o)})},o.$on("removeTagFilter",function(){o.tagFilter=!1}),o.$on("addTagFilter",function(){o.tagFilter=!0}),o.$on("notifications",function(){n.getUser(o.currentUser._id).success(function(t){o.picture=e.loggedInUser.picture,o.newNotifications=t.notifications.filter(function(o){return!o.seen})}).error(function(o){console.log("error: ",o)})}),o.$on("loggedOut",function(){o.loggedIn=e.isLoggedIn(),o.notifications=[]}),o.$on("loggedIn",function(){o.loggedIn=e.isLoggedIn(),o.currentUser=e.currentUser(),n.getUser(o.currentUser._id).success(function(t){o.picture=e.loggedInUser.picture,o.newNotifications=t.notifications.filter(function(o){return!o.seen})}).error(function(o){console.log("error: ",o)})})}),app.directive("ngEnter",function(){return function(o,t,e){t.bind("keydown keypress",function(t){13===t.which&&(o.$apply(function(){o.$eval(e.ngEnter)}),t.preventDefault())})}}),app.factory("auth",function(o,t,e){var n={};return n.loggedInUser,n.saveToken=function(t){o.localStorage[e]=t},n.getToken=function(){return o.localStorage[e]},n.isLoggedIn=function(){var t=n.getToken();if(t){var e=JSON.parse(o.atob(t.split(".")[1]));return e.exp>Date.now()/1e3}return!1},n.currentUser=function(){if(n.isLoggedIn()){var e=n.getToken(),s=JSON.parse(o.atob(e.split(".")[1]));return t.get("/users/"+s._id).then(function(o){n.loggedInUser=o.data})["catch"](function(o){console.log("err",o)}),s}},n.register=function(o){return t.post("/auth/register",o).success(function(o){n.saveToken(o.token)})},n.login=function(o){return t.post("/auth/login",o).success(function(o){n.saveToken(o.token)})},n.logout=function(){o.localStorage.removeItem(e)},n}),app.factory("postFactory",function(o,t){var e={};return e.createPost=function(o){return t.post("/posts/add",o)},e.deletePost=function(o){return t["delete"]("/posts/delete",o)},e.changeStats=function(o){return t.put("/posts/changeStats",o)},e.getPost=function(o){return t.get("/posts/"+o.pid)},e.editPost=function(o){return t.put("/posts/edit",o)},e.getPostsByTag=function(o){return t.get("/posts/sorted/user/topic/tag/"+o+"/postType/")},e.getPostsByTopic=function(o){return t.get("/posts/sorted/user/topic/"+o+"/tag/postType/")},e.getSortedPosts=function(o){return t.get("/posts/sorted/"+o.sortingMethod+"/user/topic/tag/postType/"+o.postType)},e.subscriptionsPosts=function(o){return t.get("/posts/sorted/user/"+o+"/topic/tag/postType/")},e.getSortedComments=function(o){return console.log(o),t.get("/posts/sortedComments/"+o.sortingMethod+"/post/"+o.pid)},e.getSortedAnswers=function(o){return console.log(o),t.get("/posts/sortedComments/"+o.sortingMethod+"/post/"+o.pid)},e.formatLikedPosts=function(o,t){o.map(function(o){return o.likers.forEach(function(e){if(e.toString()===t._id.toString()){var n=o;return n.liked=!0,n}return o})}),o.map(function(o){return o.dislikers.forEach(function(e){if(e.toString()===t._id.toString()){var n=o;return n.disliked=!0,n}return o})})},e.formatTags=function(o){o.map(function(o){var t="";return o.tags.forEach(function(o){t+=o+", "}),o.tags=t,o})},e.formatUserPosts=function(o,t){o.map(function(o){o.author._id.toString()===t._id.toString()?o.userPost=!0:o.userPost=!1})},e.formatPosts=function(o,t){return e.formatLikedPosts(o,t),e.formatUserPosts(o,t),e.formatTags(o),o},e}),app.factory("topicFactory",function(o,t){var e={};return e.getTopics=function(){return t.get("/topics/allTopics")},e.subscribedTopics=function(){return t.get("/topics/allTopics")},e.get7Topics=function(){return t.get("/topics/limit7")},e.getTopic=function(o){return t.get("/topics/topic/"+o)},e.createTopic=function(o){return t.post("/topics/add",o)},e.deleteTopic=function(o){return t["delete"]("/topics/delete",o)},e}),app.factory("userFactory",function(o,t){var e={};return e.getUser=function(o){return t.get("/users/"+o)},e.getNotifs=function(o){return t.get("/users/notifications/"+o.uid)},e.clearNotifs=function(o){return t.post("/users/clearNotifications",o)},e.addKnowledge=function(o){return t.post("/users/addKnowledge",o)},e.updateInfo=function(o){return t.put("/users/updateInfo",o)},e.follow=function(o){return t.post("/users/follow",o)},e.unfollow=function(o){return t.put("/users/unfollow",o)},e.subscribe=function(o){return t.post("/users/subscribe",o)},e.unsubscribe=function(o){return t.put("/users/unsubscribe",o)},e});