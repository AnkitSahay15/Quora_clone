"use strict";var app=angular.module("quora",["ui.router","infinite-scroll","hc.marked","oitozero.ngSweetAlert"]);app.constant("tokenStorageKey","my-token"),app.filter("unsafe",function(o){return function(t){return o.trustAsHtml(t)}}).run(function(o){o.$on("logout",function(){o.$broadcast("loggedOut")}),o.$on("login",function(){o.$broadcast("loggedIn")})}),app.config(["$stateProvider","$locationProvider","$urlRouterProvider","markedProvider",function(o,t,e,n){t.html5Mode(!0).hashPrefix("!"),n.setOptions({gfm:!0,tables:!0,highlight:function(o,t){return t?hljs.highlight(t,o,!0).value:hljs.highlightAuto(o).value}}),o.state("home",{url:"/",templateUrl:"/html/general/home.html",controller:"homeCtrl"}).state("post",{url:"/post",templateUrl:"/html/general/write.html",controller:"writeCtrl"}).state("thread",{url:"/thread",templateUrl:"/html/general/thread.html",controller:"threadCtrl"}).state("topic",{url:"/topics/:topic?",templateUrl:"/html/general/topic.html",controller:"topicCtrl"}).state("users",{"abstract":!0,templateUrl:"/html/users/users.html"}).state("users.login",{url:"/login",templateUrl:"/html/users/form.html",controller:"usersCtrl"}).state("users.profile",{url:"/profile",templateUrl:"/html/users/profile.html",controller:"profileCtrl"}),e.otherwise("/")}]),app.controller("homeCtrl",function(o,t,e,n,s,i,r,c){o.posts,o.topicFeed;var l=s.currentUser();o.loggedIn=s.isLoggedIn(),function(){o.posts=[],o.topicFeed=[];var t={postType:"question"};e.getSortedPosts(t).success(function(t){l?(e.formatLikedPosts(t,l),console.log("posts: ",t),o.posts=t):o.posts=t}).error(function(o){console.log("error: ",o)}),n.get7Topics().success(function(t){console.log(t),o.topicFeed=t}).error(function(o){console.log("error: ",o)})}(),o.togglePostLike=function(n){swal({title:"Not Logged In!",text:"You must be logged in to complete this action.",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Go to Login?",closeOnConfirm:!1},function(){swal({title:"Redirecting!",type:"success",timer:750,showConfirmButton:!1}),t.go("users.login")});var i;i=o.posts[n].liked?"dislike":"like";var r={pid:o.posts[n]._id,uid:l._id,type:i,token:s.getToken()};e.changeStats(r).success(function(t){"like"===i?(o.posts[n].likes+=1,o.posts[n].liked=!0):(o.posts[n].likes-=1,o.posts[n].liked=!1)}).error(function(o){console.log("error: ",o)})},o.toggleCommentLike=function(t){var n;n=o.comments[t].liked?"dislike":"like";var i={pid:o.comments[t]._id,uid:l._id,type:n,token:s.getToken()};e.changeStats(i).success(function(e){"like"===n?(o.comments[t].likes+=1,o.comments[t].liked=!0):(o.comments[t].likes-=1,o.comments[t].liked=!1)}).error(function(o){console.log("error: ",o)})},o.showComments=function(t){o.posts[t].showComments=!0;var n=(o.posts[t].comments,{sortingMethod:"likes",pid:o.posts[t]._id});e.getSortedComments(n).success(function(t){l?(e.formatLikedPosts(t,l),o.comments=t):o.comments=t})},o.hideComments=function(t){o.posts[t].showComments=!1},o.submitComment=function(t,n){var i={content:t,author:l._id,responseTo:n._id,postType:"comment",token:s.getToken()};e.createPost(i).success(function(t){o.comments.push(t),console.log(t)}).error(function(o){console.log("error: ",o)})},o.$on("loggedOut",function(){o.loggedIn=s.isLoggedIn()}),o.$on("loggedIn",function(){console.log("inside logged in listener"),o.loggedIn=s.isLoggedIn()}),e.getPostsByTag()}),app.controller("navCtrl",function(o,t,e,n){o.loggedIn=e.isLoggedIn(),o.logout=function(){e.logout(),o.loggedIn=!1,t.go("home")}}),app.controller("profileCtrl",function(o,t,e){console.log("PROFILE CTRL WORKING")}),app.controller("threadCtrl",function(o,t,e){o.displayComments=!1,o.displayAnswerForm=!1;$rootScope.getCurrentUser;o.showComments=function(){o.displayComments=!o.displayComments},o.showAnswerForm=function(){o.displayAnswerForm=!o.displayAnswerForm},o.comments=[{author:"billy",content:"this is a comment on a question in quora oh my god oh my god oh my god"},{author:"billy",content:"this is a comment on a question in quora oh my god oh my god oh my god",likes:19},{author:"billy",content:"this is a comment on a question in quora oh my god oh my god oh my god",views:19},{author:"billy",content:"this is a comment on a question in quora oh my god oh my god oh my god"},{author:"billy",content:"this is a comment on a question in quora oh my god oh my god oh my god"}],o.loadMore=function(){for(var t=o.comments[o.comments.length-1],e=8,n=1;e>=n;n++)console.log("count is "+n),o.comments.push(t+"")}}),app.controller("topicCtrl",function(o,t,e,n,s,i){var r=s.currentUser();console.log("ok"),function(){o.posts=[],o.topicFeed=[],n.getTopic(e.topic).success(function(t){console.log("topic: ",t),o.topic=t,o.posts=t.posts}).error(function(o){console.log("error: ",o)})}(),o.togglePostLike=function(t){var e;e=o.posts[t].liked?"dislike":"like";var n={pid:o.posts[t]._id,uid:r._id,type:e};i.changeStats(n).success(function(n){"like"===e?(o.posts[t].likes+=1,o.posts[t].liked=!0):(o.posts[t].likes-=1,o.posts[t].liked=!1)}).error(function(o){console.log("error: ",o)})},o.toggleCommentLike=function(t){var e;e=o.comments[t].liked?"dislike":"like";var n={pid:o.comments[t]._id,uid:r._id,type:e};i.changeStats(n).success(function(n){"like"===e?(o.comments[t].likes+=1,o.comments[t].liked=!0):(o.comments[t].likes-=1,o.comments[t].liked=!1)}).error(function(o){console.log("error: ",o)})},o.showComments=function(t){o.posts[t].showComments=!0;var e=(o.posts[t].comments,{sortingMethod:"likes",pid:o.posts[t]._id});i.getSortedComments(e).success(function(t){i.formatLikedPosts(t,r),console.log(t),o.comments=t})},o.hideComments=function(t){o.posts[t].showComments=!1},o.submitComment=function(t,e){var n={content:t,author:r._id,responseTo:e._id,postType:"comment"};i.createPost(n).success(function(t){o.comments.push(t),console.log(t)}).error(function(o){console.log("error: ",o)})},o.$on("loggedOut",function(){o.loggedIn=s.isLoggedIn()}),o.$on("loggedIn",function(){console.log("inside logged in listener"),o.loggedIn=s.isLoggedIn()})}),app.controller("usersCtrl",function(o,t,e,n,s){o.Login=!1,o.loggedIn=e.isLoggedIn(),(o.switchState=function(){o.Login=!o.Login,o.Login?o.currentState="Create Account":o.currentState="Go to Login",o.Login?o.formState="Login":o.formState="Register"})(),o.submit=function(n){var s=o.Login?e.login:e.register;console.log("user",n),s(n).success(function(e){console.log(e),o.$emit("login"),t.go("home")}).error(function(t){console.log(t),o.user={},alert(t)})},o.logout=function(){e.logout(),o.$emit("logout"),t.go("home")},o.filterByTag=function(o){postFactory.getPostsByTag(o)},o.$on("loggedOut",function(){o.loggedIn=e.isLoggedIn()}),o.$on("loggedIn",function(){console.log("inside logged in listener"),o.loggedIn=e.isLoggedIn()})}),app.controller("writeCtrl",function(o,t,e,n,s){e.currentUser();$(document).foundation(),o.topics=[],function(){console.log("Populate topics function starts"),o.topics=["john","wayne","Gacy","adam","Darius","Gary","Dude","Wilson","Joe","alex"]}(),o.checkTopic=function(){console.log("NG CHANGE"),o.topic?console.log("NOT EMPTY"):console.log("EMPTY TOPICS")},o.submitQuestion=function(o,t){console.log("SUBMIT POST FUNCTION STARTS");var e={author:t._id,title:o.title,tags:o.tags,content:o.content,topic:o.topic,postType:"question"};n.createPost(e)}}),app.factory("auth",function(o,t,e){var n={};return n.saveToken=function(t){o.localStorage[e]=t},n.getToken=function(){return o.localStorage[e]},n.isLoggedIn=function(){var t=n.getToken();if(t){var e=JSON.parse(o.atob(t.split(".")[1]));return e.exp>Date.now()/1e3}return!1},n.currentUser=function(){if(n.isLoggedIn()){var t=n.getToken(),e=JSON.parse(o.atob(t.split(".")[1]));return e}},n.register=function(o){return t.post("/register",o).success(function(o){n.saveToken(o.token)})},n.login=function(o){return t.post("/login",o).success(function(o){n.saveToken(o.token)})},n.logout=function(){o.localStorage.removeItem(e)},n}),app.factory("postFactory",function(o,t){var e={};return e.createPost=function(o){return t.post("/api/posts/add",o)},e.deletePost=function(o){return t["delete"]("/api/posts/delete",o)},e.changeStats=function(o){return t.put("/api/posts/changeStats",o)},e.editPost=function(o){return t.put("/api/posts/edit",o)},e.getPostsByTag=function(o){return t.get("/api/posts/sorted/user/topic/tag/"+o+"/postType/")},e.getPostsByTopic=function(o){return t.get("/api/posts/sorted/user/topic/"+o+"/tag/postType/")},e.getSortedPosts=function(o){return t.get("/api/posts/sorted/"+o.sortingMethod+"/user/topic/tag/postType/"+o.postType)},e.getSortedComments=function(o){return console.log(o),t.get("/api/posts/sortedComments/"+o.sortingMethod+"/post/"+o.pid)},e.formatLikedPosts=function(o,t){var e=o.map(function(o){return o.likers.forEach(function(e){if(e.toString()===t._id.toString()){console.log("inside if statement",o);var n=o;return n.liked=!0,n}return o})});return e},e}),app.factory("topicFactory",function(o,t){var e={};return e.getTopics=function(){return t.get("/api/topics/allTopics")},e.get7Topics=function(){return t.get("/api/topics/limit7")},e.getTopic=function(o){return t.get("/api/topics/topic/"+o)},e.createTopic=function(o){return t.post("/api/topics/add",o)},e.deleteTopic=function(o){return t["delete"]("/api/topics/delete",o)},e}),app.factory("userFactory",function(o,t){var e={};return e.addKnowledge=function(o){return t.post("/api/users/addKnowledge",o)},e.updateInfo=function(o){return t.put("/api/users/updateInfo",o)},e.follow=function(o){return t.post("/api/users/follow",o)},e.unfollow=function(o){return t.put("/api/users/unfollow",o)},e.subscribe=function(o){return t.post("/api/users/subscribe",subscribeObject)},e.unsubscribe=function(o){return t.put("/api/users/unsubscribe",o)},e});